generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- Coaching Platform Enums ---

enum ExperienceLevel {
  beginner
  intermediate
  advanced
}

enum PrescriptionType {
  percentage
  rpe
  rir
  velocity
  autoregulated
  fixed
}

enum WeightUnit {
  kg
  lbs
}

enum ProgramType {
  individual
  template
  group
}

enum PeriodizationType {
  block
  dup
  linear
  rpe_based
  hybrid
}

enum WorkoutSessionStatus {
  NOT_STARTED
  PARTIALLY_COMPLETED
  FULLY_COMPLETED
}

enum MaxSnapshotSource {
  WORKOUT
  MANUAL
  IMPORT
}

enum NotificationRecipientType {
  COACH
  ATHLETE
}

enum NotificationType {
  PROGRAM_ASSIGNED
  WORKOUT_COMPLETED
  CHECK_IN_REMINDER
}

// --- NextAuth Models ---

model User {
  id            String    @id @default(uuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?

  accounts Account[]
  sessions Session[]

  athlete Athlete?
}

model Account {
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([provider, providerAccountId])
}

model Session {
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@id([identifier, token])
}

// --- Existing Models ---

model Submission {
  id             String   @id @default(uuid())
  generatedAt    DateTime
  trainerProfile Json
  sections       Json
  rawAnswers     Json
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

// --- Coaching Platform Models ---

model Coach {
  id                      String     @id @default(uuid())
  name                    String
  email                   String     @unique
  brandName               String?
  notificationPreferences Json       @default("{\"emailOnWorkoutComplete\":true,\"emailOnCheckIn\":true}")
  defaultWeightUnit       WeightUnit @default(lbs)
  timezone                String     @default("America/New_York")
  defaultRestTimerSeconds Int        @default(120)
  createdAt               DateTime   @default(now())
  updatedAt               DateTime   @updatedAt

  athletes  Athlete[]
  programs  Program[]
  exercises Exercise[]
  meets     CompetitionMeet[]
}

model Athlete {
  id                      String          @id @default(uuid())
  coachId                 String
  name                    String
  email                   String?
  bodyweight              Float?
  weightClass             String?
  experienceLevel         ExperienceLevel @default(intermediate)
  isRemote                Boolean         @default(true)
  isCompetitor            Boolean         @default(false)
  federation              String?
  notes                   String?         @db.Text
  metadata                Json?
  isActive                Boolean         @default(true)
  notificationPreferences Json            @default("{\"emailOnProgramAssigned\":true}")
  userId                  String?         @unique
  createdAt               DateTime        @default(now())
  updatedAt               DateTime        @updatedAt

  coach Coach @relation(fields: [coachId], references: [id])
  user  User?  @relation(fields: [userId], references: [id])

  programAssignments ProgramAssignment[]
  setLogs            SetLog[]
  bodyweightLogs     BodyweightLog[]
  meetEntries        MeetEntry[]
  workoutSessions    WorkoutSession[]
  maxSnapshots       MaxSnapshot[]

  @@index([coachId])
}

model Program {
  id                String            @id @default(uuid())
  coachId           String
  name              String
  description       String?           @db.Text
  type              ProgramType       @default(individual)
  periodizationType PeriodizationType?
  startDate         DateTime?
  endDate           DateTime?
  isTemplate        Boolean           @default(false)
  isArchived        Boolean           @default(false)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  coach           Coach                @relation(fields: [coachId], references: [id])
  workouts        Workout[]
  assignments     ProgramAssignment[]
  workoutSessions WorkoutSession[]

  @@index([coachId])
}

model ProgramAssignment {
  id           String    @id @default(uuid())
  programId    String
  athleteId    String
  assignedAt   DateTime  @default(now())
  startDate    DateTime?
  endDate      DateTime?
  trainingDays Json      @default("[1,2,4,5]")
  isActive     Boolean   @default(true)

  program         Program          @relation(fields: [programId], references: [id], onDelete: Cascade)
  athlete         Athlete          @relation(fields: [athleteId], references: [id], onDelete: Cascade)
  workoutSessions WorkoutSession[]

  @@index([programId])
  @@index([athleteId])
  @@unique([programId, athleteId])
}

model Workout {
  id         String   @id @default(uuid())
  programId  String
  name       String
  dayNumber  Int
  weekNumber Int
  notes      String?  @db.Text
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  program          Program           @relation(fields: [programId], references: [id], onDelete: Cascade)
  exercises        WorkoutExercise[]
  workoutSessions  WorkoutSession[]

  @@index([programId])
}

model Exercise {
  id               String   @id @default(uuid())
  coachId          String?
  name             String
  category         String
  force            String?
  level            String?
  mechanic         String?
  equipment        String?
  primaryMuscles   Json     @default("[]")
  secondaryMuscles Json     @default("[]")
  instructions     Json     @default("[]")
  images           Json     @default("[]")
  videoUrl         String?
  cues             String?  @db.Text
  tags             Json     @default("[]")
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  coach            Coach?            @relation(fields: [coachId], references: [id])
  workoutExercises WorkoutExercise[]
  maxSnapshots     MaxSnapshot[]

  @@index([coachId])
  @@index([name])
  @@index([category])
}

model WorkoutExercise {
  id               String           @id @default(uuid())
  workoutId        String
  exerciseId       String
  order            Int
  prescriptionType PrescriptionType @default(fixed)
  prescribedSets   String?
  prescribedReps   String?
  prescribedLoad   String?
  prescribedRPE    Float?
  prescribedRIR    Int?
  velocityTarget   Float?
  percentageOf1RM  Float?
  supersetGroup    String?
  supersetColor    String?
  isUnilateral     Boolean          @default(false)
  restTimeSeconds  Int?
  tempo            String?
  notes            String?          @db.Text
  athleteNotes     String?          @db.Text

  workout  Workout  @relation(fields: [workoutId], references: [id], onDelete: Cascade)
  exercise Exercise @relation(fields: [exerciseId], references: [id])
  setLogs  SetLog[]

  @@index([workoutId])
  @@index([exerciseId])
}

model SetLog {
  id                String     @id @default(uuid())
  workoutExerciseId String
  athleteId         String
  setNumber         Int
  reps              Int
  weight            Float
  unit              WeightUnit @default(lbs)
  rpe               Float?
  rir               Int?
  velocity          Float?
  completedAt       DateTime   @default(now())
  notes             String?    @db.Text

  workoutExercise WorkoutExercise @relation(fields: [workoutExerciseId], references: [id], onDelete: Cascade)
  athlete         Athlete         @relation(fields: [athleteId], references: [id], onDelete: Cascade)

  @@index([workoutExerciseId])
  @@index([athleteId])
  @@index([athleteId, completedAt])
}

model BodyweightLog {
  id        String     @id @default(uuid())
  athleteId String
  weight    Float
  unit      WeightUnit @default(lbs)
  loggedAt  DateTime   @default(now())

  athlete Athlete @relation(fields: [athleteId], references: [id], onDelete: Cascade)

  @@index([athleteId])
}

model CompetitionMeet {
  id         String   @id @default(uuid())
  coachId    String
  name       String
  federation String?
  date       DateTime
  location   String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  coach   Coach       @relation(fields: [coachId], references: [id])
  entries MeetEntry[]

  @@index([coachId])
}

model MeetEntry {
  id          String  @id @default(uuid())
  meetId      String
  athleteId   String
  weightClass String?
  squat1      Float?
  squat2      Float?
  squat3      Float?
  bench1      Float?
  bench2      Float?
  bench3      Float?
  deadlift1   Float?
  deadlift2   Float?
  deadlift3   Float?
  openers        Json?
  warmupPlan     Json?
  attemptResults Json?
  notes          String? @db.Text

  meet    CompetitionMeet @relation(fields: [meetId], references: [id], onDelete: Cascade)
  athlete Athlete         @relation(fields: [athleteId], references: [id], onDelete: Cascade)

  @@index([meetId])
  @@index([athleteId])
}

model WorkoutSession {
  id                    String               @id @default(uuid())
  athleteId             String
  date                  DateTime             @db.Date
  programId             String?
  title                 String?
  durationSeconds       Int?
  completionPercentage  Float                @default(0)
  completedItems        Int                  @default(0)
  totalItems            Int                  @default(0)
  status                WorkoutSessionStatus @default(NOT_STARTED)
  workoutId             String?
  programAssignmentId   String?
  isManuallyScheduled   Boolean              @default(false)
  isSkipped             Boolean              @default(false)
  weekNumber            Int?
  dayNumber             Int?
  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt

  athlete           Athlete            @relation(fields: [athleteId], references: [id], onDelete: Cascade)
  program           Program?           @relation(fields: [programId], references: [id], onDelete: SetNull)
  workout           Workout?           @relation(fields: [workoutId], references: [id], onDelete: SetNull)
  programAssignment ProgramAssignment? @relation(fields: [programAssignmentId], references: [id], onDelete: SetNull)

  @@unique([athleteId, date])
  @@index([athleteId])
  @@index([athleteId, date])
  @@index([programId])
  @@index([workoutId])
  @@index([programAssignmentId])
}

model MaxSnapshot {
  id           String            @id @default(uuid())
  athleteId    String
  exerciseId   String
  date         DateTime
  workingMax   Float
  generatedMax Float?
  isCurrentMax Boolean           @default(false)
  source       MaxSnapshotSource @default(WORKOUT)
  createdAt    DateTime          @default(now())

  athlete  Athlete  @relation(fields: [athleteId], references: [id], onDelete: Cascade)
  exercise Exercise @relation(fields: [exerciseId], references: [id])

  @@index([athleteId])
  @@index([exerciseId])
  @@index([athleteId, exerciseId])
  @@index([athleteId, date])
}

model Notification {
  id            String                    @id @default(uuid())
  recipientId   String
  recipientType NotificationRecipientType
  type          NotificationType
  title         String
  body          String                    @db.Text
  isRead        Boolean                   @default(false)
  createdAt     DateTime                  @default(now())

  @@index([recipientId, recipientType])
  @@index([recipientId, isRead])
}
